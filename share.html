<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PinoyTechFeed Â· Share Dashboard</title>
<meta name="robots" content="noindex,nofollow" />
<style>
  :root { --bg:#0b1220; --fg:#e2e8f0; --muted:#94a3b8; --card:#0f172a; --brd:#213048; --accent:#22c55e;}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial;}
  header{position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter: blur(8px);border-bottom:1px solid var(--brd);padding:12px 16px;z-index:10}
  h1{margin:0;font-size:18px}
  .wrap{max-width:1100px;margin:16px auto;padding:0 16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
  input[type="search"]{flex:1;min-width:240px;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#0a1020;color:var(--fg)}
  .btn{display:inline-block;border:1px solid var(--brd);background:#0b1324;color:var(--fg);padding:8px 12px;border-radius:8px;text-decoration:none;font-size:14px;cursor:pointer}
  .btn:hover{border-color:#375184}
  .btn-accent{background:var(--accent);border-color:#1da34f;color:#06220f}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .meta{color:var(--muted);font-size:12px}
  .title{font-weight:600;line-height:1.3}
  .thumb{width:100%;height:180px;object-fit:cover;border-radius:8px;border:1px solid var(--brd);background:#0b1220}
  .btnrow{display:flex;flex-wrap:wrap;gap:8px}
  .source{font-size:12px;color:#9db7d8}
  footer{color:#86a1be;text-align:center;padding:20px 0}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:6px 10px;border:1px solid var(--brd);border-radius:999px;cursor:pointer}
  .tab.active{background:#12203a}
  .notice{margin:10px 0;padding:10px;border:1px dashed #5472a3;border-radius:8px;color:#a6c4ff;background:#0b1324}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <h1>ðŸ“£ PinoyTechFeed Â· Share Dashboard</h1>
    <a class="btn btn-accent" href="/" target="_blank" rel="noopener">Open Site</a>
  </div>
</header>

<main class="wrap">
  <div id="debug" class="notice" style="display:none"></div>

  <div class="toolbar">
    <div class="tabs" id="tabs">
      <span class="tab active" data-filter="">All</span>
      <span class="tab" data-filter="gadgets">Gadgets</span>
      <span class="tab" data-filter="ph">PH News</span>
      <span class="tab" data-filter="tech">Tech &amp; Innovation</span>
    </div>
    <input id="q" type="search" placeholder="Filter by titleâ€¦ (e.g., Samsung, iPhone, PAGCOR)" />
    <button class="btn" id="copyAll">Copy 3 latest captions</button>
  </div>

  <div id="list" class="grid" aria-live="polite">Loadingâ€¦</div>
</main>

<footer>
  <div class="wrap">Tips: For Page scheduling, open Meta Business Suite and paste the link or the copied caption.</div>
</footer>

<script>
(function() {
  const FEED_URL = '/feed.xml';
  const MAP_URL  = '/p/map.json'; // built by build-site.php
  const UTM_BASE = { utm_medium: 'social', utm_campaign: 'ptf_share' };

  const listEl = document.getElementById('list');
  const qEl = document.getElementById('q');
  const tabsEl = document.getElementById('tabs');
  const copyAllEl = document.getElementById('copyAll');
  const debugEl = document.getElementById('debug');

  let items = [];
  let currentFilter = '';
  let map = {}; // srcLink -> sitePage

  function showDebug(msg) { debugEl.style.display='block'; debugEl.textContent = msg; }

  function addUTM(url, source) {
    try {
      const u = new URL(url);
      u.searchParams.set('utm_source', source);
      u.searchParams.set('utm_medium', UTM_BASE.utm_medium);
      u.searchParams.set('utm_campaign', UTM_BASE.utm_campaign);
      return u.toString();
    } catch {
      const sep = url.includes('?') ? '&' : '?';
      return `${url}${sep}utm_source=${encodeURIComponent(source)}&utm_medium=${encodeURIComponent(UTM_BASE.utm_medium)}&utm_campaign=${encodeURIComponent(UTM_BASE.utm_campaign)}`;
    }
  }

  function hashtagsFor(tag) {
    if (tag === 'gadgets') return '#Gadgets #PinoyTechFeed';
    if (tag === 'ph')      return '#PHNews #PinoyTechFeed';
    if (tag === 'tech')    return '#Tech #PinoyTechFeed';
    return '#PinoyTechFeed';
  }

  const slugify = (s)=> s.toLowerCase().trim()
    .replace(/[^a-z0-9]+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');

  function siteTargetFor(it) {
    // 1) map.json (most accurate)
    if (map[it.link]) return map[it.link];
    // 2) guess by title slug (works if unique)
    const guess = '/p/' + slugify(it.title) + '.html';
    return guess;
  }

  function toCaption(it, withHashtags = true) {
    const hash = withHashtags ? ` ${hashtagsFor(it.tag)}` : '';
    const link = addUTM(siteTargetFor(it), 'facebook');
    return `${it.title} â€” Read more: ${link}${hash}`;
  }

  function summarizeCounts(items) {
    const c = { all: items.length, gadgets: 0, ph: 0, tech: 0, unknown: 0 };
    for (const it of items) {
      if (it.tag === 'gadgets') c.gadgets++;
      else if (it.tag === 'ph') c.ph++;
      else if (it.tag === 'tech') c.tech++;
      else c.unknown++;
    }
    return `Loaded ${c.all} Â· Gadgets: ${c.gadgets} Â· PH: ${c.ph} Â· Tech: ${c.tech} Â· Unknown: ${c.unknown}`;
  }

  function render() {
    const q = (qEl.value || '').toLowerCase().trim();
    const rows = [];
    for (const it of items) {
      const matchesTab = !currentFilter || it.tag === currentFilter;
      const matchesQ = !q || (it.title.toLowerCase().includes(q) || it.link.toLowerCase().includes(q));
      if (!(matchesTab && matchesQ)) continue;

      const siteUrl = siteTargetFor(it);
      rows.push(`
        <article class="card">
          ${it.img ? `<img class="thumb" src="${it.img}" referrerpolicy="no-referrer" onerror="this.style.display='none'" alt="">` : ``}
          <div class="title"><a href="${siteUrl}" target="_blank" rel="noopener">${it.title}</a></div>
          <div class="meta">${new Date(it.date).toLocaleString()}</div>
          <div class="source">Category: ${it.tag ? it.tag.toUpperCase() : 'GENERAL'} Â· Source: ${it.source || ''}</div>
          <div class="btnrow">
            <button class="btn" data-copy="${encodeURIComponent(toCaption(it))}">Copy caption</button>
            <button class="btn" data-copysite="${encodeURIComponent(addUTM(siteUrl,'facebook'))}">Copy site link</button>
          </div>
        </article>
      `);
    }
    listEl.innerHTML = rows.join('') || `<div class="meta">No items match your filter.</div>`;

    [...listEl.querySelectorAll('button[data-copy]')].forEach(btn => {
      btn.addEventListener('click', async () => {
        const text = decodeURIComponent(btn.getAttribute('data-copy'));
        try { await navigator.clipboard.writeText(text); alert('Caption copied!'); }
        catch { prompt('Copy this:', text); }
      });
    });
    [...listEl.querySelectorAll('button[data-copysite]')].forEach(btn => {
      btn.addEventListener('click', async () => {
        const text = decodeURIComponent(btn.getAttribute('data-copysite'));
        try { await navigator.clipboard.writeText(text); alert('Site link copied!'); }
        catch { prompt('Copy this:', text); }
      });
    });
  }

  tabsEl.addEventListener('click', (e) => {
    const t = e.target.closest('.tab'); if (!t) return;
    [...tabsEl.children].forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    currentFilter = t.dataset.filter || '';
    render();
  });
  qEl.addEventListener('input', () => render());

  copyAllEl.addEventListener('click', async () => {
    const shown = [...listEl.querySelectorAll('.card')].slice(0,3);
    const caps = shown.map(card => {
      const title = card.querySelector('.title')?.innerText || '';
      const site   = card.querySelector('.title a')?.href || '';
      const withUtm = addUTM(site, 'facebook');
      return `${title} â€” Read more: ${withUtm} #PinoyTechFeed`;
    }).join('\n\n');
    try { await navigator.clipboard.writeText(caps); alert('Top 3 captions copied!'); }
    catch { prompt('Copy these:', caps); }
  });

  // Helpers to map category to tag (if needed)
  function categoryToTag(catText) {
    const s=(catText||'').toLowerCase();
    if (s.includes('gadget')) return 'gadgets';
    if (s.includes('ph')) return 'ph';
    if (s.includes('tech')) return 'tech';
    return '';
  }
  function domainToTag(link) {
    try {
      const u=new URL(link); const h=u.hostname.toLowerCase(); const p=u.pathname.toLowerCase();
      if (h.includes('gsmarena')) return 'gadgets';
      if (h.includes('gmanetwork')) return 'ph';
      if (h.includes('interestingengineering') || h.includes('inquirer')) return 'tech';
      if (p.includes('/tech')||p.includes('/technology')||p.includes('/innovation')) return 'tech';
    } catch {}
    return '';
  }

  async function load() {
    try {
      // try to get /p/map.json (optional)
      try {
        const m = await fetch(MAP_URL, {cache:'no-store'});
        if (m.ok) map = await m.json();
      } catch {}

      const res = await fetch(FEED_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      const xml = new DOMParser().parseFromString(text, 'application/xml');
      let nodes = Array.from(xml.getElementsByTagName('item'));

      if (!nodes.length) {
        // manual chunk fallback
        const chunks = text.split(/<\/item>/i).filter(s=>/<item>/i.test(s)).map(s=>s+'</item>');
        items = chunks.map((chunk)=>{
          const pick = (tag)=> (chunk.match(new RegExp(`<${tag}[^>]*>([\\s\\S]*?)<\\/${tag}>`,'i'))?.[1] || '').trim();
          const enc  = chunk.match(/<enclosure[^>]*url=["']([^"']+)["']/i)?.[1];
          const mrss = chunk.match(/<(?:media:content|content)[^>]*url=["']([^"']+)["']/i)?.[1];
          const img  = enc || mrss || '';
          const tag  = categoryToTag(pick('category')) || domainToTag(pick('link'));
          return { title: pick('title'), link: pick('link'), date: pick('pubDate'), img, tag, source: pick('source') };
        });
      } else {
        items = nodes.map((it)=>{
          const get=(tag)=> (it.getElementsByTagName(tag)[0]?.textContent || '').trim();
          let img='';
          const enc = it.getElementsByTagName('enclosure')[0];
          if (enc && enc.getAttribute('url')) img = enc.getAttribute('url');
          if (!img) {
            const m1 = it.getElementsByTagName('media:content')[0];
            const m2 = it.getElementsByTagName('content')[0];
            const node = m1||m2; if (node && node.getAttribute('url')) img = node.getAttribute('url');
          }
          const tag = categoryToTag(get('category')) || domainToTag(get('link'));
          return { title:get('title')||'(no title)', link:get('link'), date:get('pubDate'), img, tag, source:get('source') };
        });
      }

      showDebug((()=>{const c={all:items.length,gadgets:0,ph:0,tech:0,unknown:0};items.forEach(it=>{if(it.tag==='gadgets')c.gadgets++;else if(it.tag==='ph')c.ph++;else if(it.tag==='tech')c.tech++;else c.unknown++;});return `Loaded ${c.all} Â· Gadgets: ${c.gadgets} Â· PH: ${c.ph} Â· Tech: ${c.tech} Â· Unknown: ${c.unknown}`;})());
      render();
    } catch (err) {
      showDebug('Failed to load feed: ' + String(err));
      listEl.innerHTML = `<div class="meta">Failed to load feed. ${String(err)}</div>`;
    }
  }

  load();
})();
</script>
</body>
</html>