<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PinoyTechFeed Â· Share Dashboard</title>
<meta name="robots" content="noindex,nofollow" />
<style>
  :root { --bg:#0b1220; --fg:#e2e8f0; --muted:#94a3b8; --card:#0f172a; --brd:#213048; --accent:#22c55e;}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial;}
  header{position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter: blur(8px);border-bottom:1px solid var(--brd);padding:12px 16px;z-index:10}
  h1{margin:0;font-size:18px}
  .wrap{max-width:1100px;margin:16px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .meta{color:var(--muted);font-size:12px}
  .title{font-weight:600;line-height:1.3}
  .thumb{width:100%;height:220px;object-fit:cover;border-radius:8px;border:1px solid var(--brd);background:#0b1220}
  .btn{display:inline-block;border:1px solid var(--brd);background:#0b1324;color:var(--fg);padding:10px 14px;border-radius:8px;text-decoration:none;font-size:14px;cursor:pointer}
  .btn:hover{border-color:#375184}
  .btn-accent{background:var(--accent);border-color:#1da34f;color:#06220f}
  .notice{margin:10px 0;padding:10px;border:1px dashed #5472a3;border-radius:8px;color:#a6c4ff;background:#0b1324}
  .btnrow{display:flex;flex-wrap:wrap;gap:10px}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <h1>ðŸ“£ PinoyTechFeed Â· Share Dashboard</h1>
    <a class="btn btn-accent" href="/" target="_blank" rel="noopener">Open Site</a>
  </div>
</header>

<main class="wrap">
  <div id="debug" class="notice" style="display:none"></div>
  <div id="list" class="grid" aria-live="polite">Loadingâ€¦</div>
</main>

<script>
(function() {
  const FEED_URL = '/feed.xml';
  const ORIGIN   = location.origin;
  const UTM_BASE = { utm_source: 'facebook', utm_medium: 'social', utm_campaign: 'ptf_share' };

  const listEl = document.getElementById('list');
  const debugEl = document.getElementById('debug');

  function showDebug(msg){ debugEl.style.display='block'; debugEl.textContent=msg; }

  // === must MATCH build-site.php ===
  function slugify(s){
    return (s||'').toLowerCase()
      .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')
      .slice(0,70) || 'post';
  }
  function shortHash(link){ return (window.crypto?.subtle ? null : null), md5(link).slice(0,6); }
  // Tiny MD5 (enough for short hash)
  function md5(str){ // simplified tiny MD5 (fast + small)
    function rhex(n){var s='',j;for(j=0;j<4;j++)s+=('0'+((n>>>(j*8))&255).toString(16)).slice(-2);return s;}
    function cmn(q,a,b,x,s,t){return ((a+q+x+t)|0)<<(s)|((a+q+x+t)|0)>>> (32-s), (((a+q+x+t)|0) << s | ((a+q+x+t)|0) >>> (32-s)) + b | 0;}
    function ff(a,b,c,d,x,s,t){return cmn((b & c) | (~b & d),a,b,x,s,t);}
    function gg(a,b,c,d,x,s,t){return cmn((b & d) | (c & ~d),a,b,x,s,t);}
    function hh(a,b,c,d,x,s,t){return cmn(b ^ c ^ d,a,b,x,s,t);}
    function ii(a,b,c,d,x,s,t){return cmn(c ^ (b | ~d),a,b,x,s,t);}
    function toBlocks(s){
      var n=s.length, i, blocks=[];
      for(i=0;i<n;i++) blocks[i>>2]=(blocks[i>>2]||0)| (s.charCodeAt(i) << ((i%4)*8));
      blocks[n>>2]=(blocks[n>>2]||0)| (0x80 << ((n%4)*8));
      blocks[((n + 8) >> 6 << 4) + 14] = n*8;
      return blocks;
    }
    var x=toBlocks(unescape(encodeURIComponent(str))), a=1732584193,b=-271733879,c=-1732584194,d=271733878,i;
    for(i=0;i<x.length;i+=16){
      var olda=a,oldb=b,oldc=c,oldd=d;
      a=ff(a,b,c,d,x[i+0],7,-680876936); d=ff(d,a,b,c,x[i+1],12,-389564586); c=ff(c,d,a,b,x[i+2],17,606105819); b=ff(b,c,d,a,x[i+3],22,-1044525330);
      a=ff(a,b,c,d,x[i+4],7,-176418897); d=ff(d,a,b,c,x[i+5],12,1200080426); c=ff(c,d,a,b,x[i+6],17,-1473231341); b=ff(b,c,d,a,x[i+7],22,-45705983);
      a=ff(a,b,c,d,x[i+8],7,1770035416); d=ff(d,a,b,c,x[i+9],12,-1958414417); c=ff(c,d,a,b,x[i+10],17,-42063); b=ff(b,c,d,a,x[i+11],22,-1990404162);
      a=ff(a,b,c,d,x[i+12],7,1804603682); d=ff(d,a,b,c,x[i+13],12,-40341101); c=ff(c,d,a,b,x[i+14],17,-1502002290); b=ff(b,c,d,a,x[i+15],22,1236535329);
      a=gg(a,b,c,d,x[i+1],5,-165796510); d=gg(d,a,b,c,x[i+6],9,-1069501632); c=gg(c,d,a,b,x[i+11],14,643717713); b=gg(b,c,d,a,x[i+0],20,-373897302);
      a=gg(a,b,c,d,x[i+5],5,-701558691); d=gg(d,a,b,c,x[i+10],9,38016083); c=gg(c,d,a,b,x[i+15],14,-660478335); b=gg(b,c,d,a,x[i+4],20,-405537848);
      a=gg(a,b,c,d,x[i+9],5,568446438); d=gg(d,a,b,c,x[i+14],9,-1019803690); c=gg(c,d,a,b,x[i+3],14,-187363961); b=gg(b,c,d,a,x[i+8],20,1163531501);
      a=gg(a,b,c,d,x[i+13],5,-1444681467); d=gg(d,a,b,c,x[i+2],9,-51403784); c=gg(c,d,a,b,x[i+7],14,1735328473); b=gg(b,c,d,a,x[i+12],20,-1926607734);
      a=hh(a,b,c,d,x[i+5],4,-378558); d=hh(d,a,b,c,x[i+8],11,-2022574463); c=hh(c,d,a,b,x[i+11],16,1839030562); b=hh(b,c,d,a,x[i+14],23,-35309556);
      a=hh(a,b,c,d,x[i+1],4,-1530992060); d=hh(d,a,b,c,x[i+4],11,1272893353); c=hh(c,d,a,b,x[i+7],16,-155497632); b=hh(b,c,d,a,x[i+10],23,-1094730640);
      a=hh(a,b,c,d,x[i+13],4,681279174); d=hh(d,a,b,c,x[i+0],11,-358537222); c=hh(c,d,a,b,x[i+3],16,-722521979); b=hh(b,c,d,a,x[i+6],23,76029189);
      a=ii(a,b,c,d,x[i+0],6,-198630844); d=ii(d,a,b,c,x[i+7],10,1126891415); c=ii(c,d,a,b,x[i+14],15,-1416354905); b=ii(b,c,d,a,x[i+5],21,-57434055);
      a=ii(a,b,c,d,x[i+12],6,1700485571); d=ii(d,a,b,c,x[i+3],10,-1894986606); c=ii(c,d,a,b,x[i+10],15,-1051523); b=ii(b,c,d,a,x[i+1],21,-2054922799);
      a=(a+olda)|0; b=(b+oldb)|0; c=(c+oldc)|0; d=(d+oldd)|0;
    }
    return rhex(a)+rhex(b)+rhex(c)+rhex(d);
  }

  // image proxy to avoid broken thumbs
  function proxyImg(url){
    if(!url) return '';
    return 'https://images.weserv.nl/?url=' + encodeURIComponent(url.replace(/^https?:\/\//,''));
  }

  function addUTM(u){
    const url = new URL(u);
    url.searchParams.set('utm_source', UTM_BASE.utm_source);
    url.searchParams.set('utm_medium', UTM_BASE.utm_medium);
    url.searchParams.set('utm_campaign', UTM_BASE.utm_campaign);
    return url.toString();
  }

  function siteLinkOf(title, link){
    const slug = slugify(title) + '-' + shortHash(link);
    return ORIGIN + '/p/' + slug + '.html';
  }

  function summarizeCounts(items){
    const c = { all: items.length, gadgets:0, ph:0, tech:0 };
    items.forEach(it => c[it.tag]!==undefined && c[it.tag]++);
    return `Loaded ${c.all} Â· Gadgets: ${c.gadgets} Â· PH: ${c.ph} Â· Tech: ${c.tech} Â· Unknown: ${c.all - (c.gadgets+c.ph+c.tech)}`;
  }

  function categoryToTag(catText){
    const s=(catText||'').toLowerCase();
    if(s.includes('gadget')) return 'gadgets';
    if(s.includes('ph')) return 'ph';
    if(s.includes('tech')) return 'tech';
    return '';
  }

  async function load(){
    try{
      const res = await fetch(FEED_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const txt = await res.text();
      const xml = new DOMParser().parseFromString(txt,'application/xml');
      const items = [...xml.querySelectorAll('item')].map(it=>{
        const title = it.querySelector('title')?.textContent?.trim() || '(no title)';
        const link  = it.querySelector('link')?.textContent?.trim() || '';
        const date  = it.querySelector('pubDate')?.textContent?.trim() || '';
        const cat   = it.querySelector('category')?.textContent?.trim() || '';
        const tag   = categoryToTag(cat);
        let img = it.querySelector('enclosure')?.getAttribute('url') || '';
        if(!img){
          const m = it.querySelector('media\\:content, content');
          if(m && m.getAttribute('url')) img = m.getAttribute('url');
        }
        const source = it.querySelector('source')?.textContent?.trim() || (new URL(link)).hostname.replace(/^www\./,'');
        const site   = siteLinkOf(title, link);
        return { title, link, date, img, tag, source, site };
      });

      showDebug(summarizeCounts(items));
      render(items);
    }catch(e){
      showDebug('Failed to load feed: '+e.message);
    }
  }

  function render(items){
    listEl.innerHTML = items.map(it=>{
      const dt = new Date(it.date||Date.now());
      const pretty = isNaN(dt) ? (it.date||'') : dt.toLocaleString();
      const img = it.img ? proxyImg(it.img) : '';
      const cap = `${it.title} â€” Read more: ${addUTM(it.site)} #PinoyTechFeed`;
      return `
      <article class="card">
        ${img?`<img class="thumb" referrerpolicy="no-referrer" src="${img}" alt="">`:''}
        <div class="title"><a href="${it.site}" target="_blank" rel="noopener">${it.title}</a></div>
        <div class="meta">${pretty}</div>
        <div class="meta">Category: ${it.tag?it.tag.toUpperCase():'GENERAL'} Â· Source: ${it.source}</div>
        <div class="btnrow">
          <button class="btn" data-copy="${encodeURIComponent(cap)}">Copy caption</button>
          <button class="btn" data-copy="${encodeURIComponent(addUTM(it.site))}">Copy site link</button>
        </div>
      </article>`;
    }).join('');

    [...listEl.querySelectorAll('button[data-copy]')].forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const text = decodeURIComponent(btn.getAttribute('data-copy')||'');
        try{ await navigator.clipboard.writeText(text); alert('Copied!'); }
        catch{ prompt('Copy this:', text); }
      });
    });
  }

  load();
})();
</script>
</body>
</html>