<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PinoyTechFeed Â· Share Dashboard</title>
<meta name="robots" content="noindex,nofollow" />
<style>
  :root { --bg:#0b1220; --fg:#e2e8f0; --muted:#94a3b8; --card:#0f172a; --brd:#213048; --accent:#22c55e;}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial;}
  header{position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter: blur(8px);border-bottom:1px solid var(--brd);padding:12px 16px;z-index:10}
  h1{margin:0;font-size:18px}
  .wrap{max-width:1100px;margin:16px auto;padding:0 16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
  input[type="search"]{flex:1;min-width:240px;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#0a1020;color:var(--fg)}
  .btn{display:inline-block;border:1px solid var(--brd);background:#0b1324;color:var(--fg);padding:8px 12px;border-radius:8px;text-decoration:none;font-size:14px;cursor:pointer}
  .btn:hover{border-color:#375184}
  .btn-accent{background:var(--accent);border-color:#1da34f;color:#06220f}
  .badge{padding:3px 8px;border:1px solid #2f465f;border-radius:99px;color:#a0c5ff;font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .meta{color:var(--muted);font-size:12px}
  .title{font-weight:600;line-height:1.3}
  .thumb{width:100%;height:180px;object-fit:cover;border-radius:8px;border:1px solid var(--brd);background:#0b1220}
  .btnrow{display:flex;flex-wrap:wrap;gap:8px}
  .source{font-size:12px;color:#9db7d8}
  footer{color:#86a1be;text-align:center;padding:20px 0}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:6px 10px;border:1px solid var(--brd);border-radius:999px;cursor:pointer}
  .tab.active{background:#12203a}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <h1>ðŸ“£ PinoyTechFeed Â· Share Dashboard</h1>
    <a class="btn btn-accent" href="/" target="_blank" rel="noopener">Open Site</a>
  </div>
</header>

<main class="wrap">
  <div class="toolbar">
    <div class="tabs" id="tabs">
      <span class="tab active" data-filter="">All</span>
      <span class="tab" data-filter="gadgets">Gadgets</span>
      <span class="tab" data-filter="ph">PH News</span>
      <span class="tab" data-filter="tech">Tech</span>
    </div>
    <input id="q" type="search" placeholder="Filter by titleâ€¦ (e.g., Samsung, iPhone, PAGCOR)" />
    <button class="btn" id="copyAll">Copy 3 latest captions</button>
  </div>

  <div id="list" class="grid" aria-live="polite">Loadingâ€¦</div>
</main>

<footer>
  <div class="wrap">Tips: For Page scheduling, open Meta Business Suite and paste the link or the copied caption.</div>
</footer>

<script>
(function() {
  // âœ… absolute url avoids any subpath issues and is friendlier to iOS Safari
  const FEED_URL = 'https://pinoytechfeed.netlify.app/feed.xml';
  const UTM_BASE = { utm_medium: 'social', utm_campaign: 'ptf_share' };

  const listEl = document.getElementById('list');
  const qEl = document.getElementById('q');
  const tabsEl = document.getElementById('tabs');
  const copyAllEl = document.getElementById('copyAll');

  let items = [];
  let currentFilter = '';

  function addUTM(url, source) {
    try {
      const u = new URL(url);
      const params = u.searchParams;
      params.set('utm_source', source);
      params.set('utm_medium', UTM_BASE.utm_medium);
      params.set('utm_campaign', UTM_BASE.utm_campaign);
      u.search = params.toString();
      return u.toString();
    } catch {
      const sep = url.includes('?') ? '&' : '?';
      return `${url}${sep}utm_source=${encodeURIComponent(source)}&utm_medium=${encodeURIComponent(UTM_BASE.utm_medium)}&utm_campaign=${encodeURIComponent(UTM_BASE.utm_campaign)}`;
    }
  }

  function hashtagsFor(tag) {
    if (tag === 'gadgets') return '#Gadgets #PinoyTechFeed';
    if (tag === 'ph')      return '#PHNews #PinoyTechFeed';
    if (tag === 'tech')    return '#Tech #PinoyTechFeed';
    return '#PinoyTechFeed';
  }

  function toCaption(it, withHashtags = true) {
    const hash = withHashtags ? ` ${hashtagsFor(it.tag)}` : '';
    const link = addUTM(it.link, 'facebook');
    return `${it.title} â€” Read more: ${link}${hash}`;
  }

  function shareLinks(it) {
    const fb = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(addUTM(it.link, 'facebook'));
    const tw = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(it.title) + '&url=' + encodeURIComponent(addUTM(it.link, 'x'));
    const li = 'https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(addUTM(it.link, 'linkedin'));
    return { fb, tw, li };
  }

  function render() {
    const q = (qEl.value || '').toLowerCase().trim();
    const rows = [];
    for (const it of items) {
      const matchesTab = !currentFilter || it.tag === currentFilter;
      const matchesQ = !q || (it.title.toLowerCase().includes(q) || it.link.toLowerCase().includes(q));
      if (!(matchesTab && matchesQ)) continue;

      const share = shareLinks(it);

      rows.push(`
        <article class="card">
          ${it.img ? `<img class="thumb" src="${it.img}" alt="">` : ``}
          <div class="title"><a href="${it.link}" target="_blank" rel="noopener">${it.title}</a></div>
          <div class="meta">${new Date(it.date).toLocaleString()}</div>
          <div class="source">Category: ${it.tag ? it.tag.toUpperCase() : 'General'} Â· Source: ${it.source}</div>
          <div class="btnrow">
            <a class="btn" target="_blank" rel="noopener" href="${share.fb}">Share to Facebook</a>
            <a class="btn" target="_blank" rel="noopener" href="${share.tw}">Share to X</a>
            <a class="btn" target="_blank" rel="noopener" href="${share.li}">Share to LinkedIn</a>
            <button class="btn" data-copy="${encodeURIComponent(toCaption(it))}">Copy caption</button>
          </div>
        </article>
      `);
    }
    listEl.innerHTML = rows.join('') || `<div class="meta">No items match your filter.</div>`;

    // wire copy buttons
    [...listEl.querySelectorAll('button[data-copy]')].forEach(btn => {
      btn.addEventListener('click', async () => {
        const text = decodeURIComponent(btn.getAttribute('data-copy'));
        try { await navigator.clipboard.writeText(text); alert('Caption copied!'); }
        catch { prompt('Copy this:', text); }
      });
    });
  }

  tabsEl.addEventListener('click', (e) => {
    const t = e.target.closest('.tab'); if (!t) return;
    [...tabsEl.children].forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    currentFilter = t.dataset.filter || '';
    render();
  });

  qEl.addEventListener('input', () => render());

  copyAllEl.addEventListener('click', async () => {
    const shown = [...listEl.querySelectorAll('.card')].slice(0,3);
    const caps = shown.map(card => {
      const title = card.querySelector('.title')?.innerText || '';
      const link  = card.querySelector('.title a')?.href || '';
      const withUtm = addUTM(link, 'facebook');
      return `${title} â€” Read more: ${withUtm} #PinoyTechFeed`;
    }).join('\n\n');
    try { await navigator.clipboard.writeText(caps); alert('Top 3 captions copied!'); }
    catch { prompt('Copy these:', caps); }
  });

  // âœ… robust loader: Safari-safe XML parsing + namespace-friendly image detection
  async function load() {
    try {
      const res = await fetch(FEED_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();

      const parser = new DOMParser();
      const xml = parser.parseFromString(text, 'text/xml');

      const parseErr = xml.getElementsByTagName('parsererror')[0];
      if (parseErr) throw new Error('XML parse error: ' + parseErr.textContent.trim());

      const raw = Array.from(xml.getElementsByTagName('item'));
      items = raw.map(it => {
        const pick = tag => (it.getElementsByTagName(tag)[0]?.textContent || '').trim();
        const title = pick('title') || '(no title)';
        const link  = pick('link');
        const date  = pick('pubDate');

        // enclosure / media:content
        let img = '';
        const enclosure = it.getElementsByTagName('enclosure')[0];
        if (enclosure && enclosure.getAttribute('url')) img = enclosure.getAttribute('url');
        if (!img) {
          const media1 = it.getElementsByTagName('media:content')[0];
          const media2 = it.getElementsByTagName('content')[0]; // fallback if prefix stripped
          const node = media1 || media2;
          if (node && node.getAttribute('url')) img = node.getAttribute('url');
        }

        // read category we stamped in the feed (Gadgets | PH | Tech)
        const catText = pick('category').toLowerCase();
        let tag = '';
        if (catText.includes('gadgets')) tag = 'gadgets';
        else if (catText === 'ph')       tag = 'ph';
        else if (catText.includes('tech')) tag = 'tech';

        // friendly source label from domain
        let source = 'Source';
        try { source = new URL(link).hostname.replace(/^www\./,''); } catch {}

        return { title, link, date, img, tag, source };
      });

      render();
    } catch (err) {
      console.error(err);
      listEl.innerHTML = `<div class="meta">Failed to load feed: ${String(err)}</div>`;
    }
  }

  load();
})();
</script>
</body>
</html>